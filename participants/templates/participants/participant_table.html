<!-- Participant Modal -->
<div class="modal fade" id="participantModal" tabindex="-1" aria-labelledby="participantModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="participantModalLabel">Add Participant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modalFormContainer">
          <!-- Form will be loaded here via AJAX -->
        </div>
      </div>
    </div>
  </div>
</div>

<table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th>Name</th>
      <th>Center</th>
      <th>Course</th>
      <th>Batch</th>
      <th>Job Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for participant in participants %}
    <tr>
      <td>{{ participant.name }}</td>
      <td>{{ participant.center_id }}</td>
      <td>{{ participant.course_id }}</td>
      <td>{{ participant.batch_id }}</td>
      <td>{{ participant.job_status }}</td>
      <td>
        <a href="{% url 'participants:participant_edit' participant.id %}" class="btn btn-sm btn-warning">Edit</a>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="6" class="text-center">No participants found</td></tr>
    {% endfor %}
  </tbody>
</table>
<script>
document.addEventListener("DOMContentLoaded", function () {
    var modal = document.getElementById("participantModal");
    var modalBody = document.getElementById("modalFormContainer");

    modal.addEventListener("show.bs.modal", function () {
    fetch("{% url 'participants:participant_add_ajax' batch.id %}")
        .then(response => response.text())
        .then(html => modalBody.innerHTML = html);
});

    // Handle form submission via AJAX
    modalBody.addEventListener("submit", function (e) {
        e.preventDefault();
        var form = e.target;
        var formData = new FormData(form);

        fetch("{% url 'participants:participant_add_ajax' batch.id %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.json().catch(() => null))
        .then(data => {
            if (data && data.success) {
                // Add new participant row to table
                var tbody = document.querySelector("table tbody");
                var newRow = `
                <tr>
                    <td>${data.participant.name}</td>
                    <td>${data.participant.center}</td>
                    <td>${data.participant.course}</td>
                    <td>${data.participant.batch}</td>
                    <td>${data.participant.job_status}</td>
                    <td>
                        <a href="/participants/edit/${data.participant.id}/" class="btn btn-sm btn-warning">Edit</a>
                    </td>
                </tr>`;
                tbody.insertAdjacentHTML("beforeend", newRow);

                // Close modal
                var modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
            } else {
                // Replace form with errors
                modalBody.innerHTML = data ? data : modalBody.innerHTML;
            }
        });
    });
});
</script>
